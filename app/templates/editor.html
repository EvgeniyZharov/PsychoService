{% extends 'base_page.html' %}
{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä –∫—É—Ä—Å–æ–≤ | MindGrow{% endblock %}

{% block content %}
<style>
    .hidden_editor {
        display: none;
    }
    .content-item {
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8fafc;
        cursor: pointer;
        transition: all 0.2s;
    }
    .content-item:hover {
        background-color: #e2e8f0;
        border-color: #cbd5e0;
    }
    .content-item.selected {
        background-color: #dbeafe;
        border-color: #3b82f6;
    }
    .content-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #2d3748;
    }
    .content-body {
        white-space: pre-line;
        color: #4a5568;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .content-body.expanded {
        max-height: 500px;
    }
    .content-preview {
        font-size: 0.875rem;
        color: #718096;
        margin-top: 0.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
    }
    .form-input:focus {
        outline: none;
        ring: 2px solid #3b82f6;
        border-color: #3b82f6;
    }
    .form-textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
        min-height: 120px;
        resize: vertical;
    }
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }
    .btn-primary:hover {
        background-color: #2563eb;
    }
    .btn-success {
        background-color: #10b981;
        color: white;
    }
    .btn-success:hover {
        background-color: #059669;
    }
    .btn-secondary {
        background-color: #6b7280;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
    }
    .btn-secondary:hover {
        background-color: #4b5563;
    }
    .question-item {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: white;
        transition: all 0.2s;
    }
    .question-item:hover {
        border-color: #3b82f6;
    }
    .answer-item {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #f9fafb;
    }
    .answer-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
</style>

<div x-data="{ section: '', subsection: '' }" class="pt-20 px-6 bg-gradient-to-br from-white to-indigo-50 min-h-screen">
    <h1 class="text-3xl font-bold text-indigo-700 mb-6">üõ† –†–µ–¥–∞–∫—Ç–æ—Ä –∫—É—Ä—Å–æ–≤</h1>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
    <div class="flex space-x-4 mb-6">
        <button @click="section = 'add'; subsection = ''" :class="section === 'add' ? 'bg-indigo-500 text-white' : 'bg-white text-indigo-600'" class="btn px-4 py-2 rounded shadow">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button @click="section = 'delete'; subsection = ''" :class="section === 'delete' ? 'bg-red-500 text-white' : 'bg-white text-red-600'" class="btn px-4 py-2 rounded shadow">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
        <button @click="section = 'update'; subsection = ''" :class="section === 'update' ? 'bg-blue-500 text-white' : 'bg-white text-blue-600'" class="btn px-4 py-2 rounded shadow">üõ† –ò–∑–º–µ–Ω–∏—Ç—å</button>
    </div>

    <!-- –ü–æ–¥–º–µ–Ω—é (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ —Ä–∞–∑–¥–µ–ª—É) -->
    <div x-show="section" class="flex gap-3 mb-8">
        <template x-if="section === 'add'">
            <div class="flex gap-3">
                <button @click="subsection = 'test'" class="btn-secondary">üß™ –¢–µ—Å—Ç</button>
                <button @click="subsection = 'course'" class="btn-secondary">üìò –ö—É—Ä—Å</button>
                <button @click="subsection = 'lesson'" class="btn-secondary">üìñ –£—Ä–æ–∫</button>
            </div>
        </template>

        <template x-if="section === 'delete'">
            <div class="flex gap-3">
                <button @click="subsection = 'delete_test'" class="btn-secondary">üóë –¢–µ—Å—Ç</button>
                <button @click="subsection = 'delete_course'" class="btn-secondary">üóë –ö—É—Ä—Å</button>
            </div>
        </template>

        <template x-if="section === 'update'">
            <div class="flex gap-3">
                <button @click="subsection = 'edit_test'" class="btn-secondary">‚úèÔ∏è –¢–µ—Å—Ç</button>
                <button @click="subsection = 'edit_course'" class="btn-secondary">‚úèÔ∏è –ö—É—Ä—Å</button>
                <button @click="subsection = 'edit_lesson'" class="btn-secondary">‚úèÔ∏è –£—Ä–æ–∫</button>
                <button @click="subsection = 'edit_content'" class="btn-secondary">‚úèÔ∏è –ö–æ–Ω—Ç–µ–Ω—Ç</button>
            </div>
        </template>
    </div>

    <!-- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–°–¢–ê –ò –í–û–ü–†–û–°–û–í -->
    <div x-show="subsection === 'edit_test'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-blue-600 mb-4">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ –∏ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>

        <!-- –í—ã–±–æ—Ä —Ç–µ—Å—Ç–∞ -->
        <div class="form-group">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</label>
            <select id="testSelect" onchange="onTestChange()" class="form-input">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç --</option>
                {% for test in tests %}
                    <option value="{{ test.id }}">{{ test.title }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
        <div id="testEditForm" class="hidden_editor mt-4 p-4 border border-gray-200 rounded">
            <h3 class="font-bold text-lg mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</h3>

            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</label>
                <input type="text" id="testTitleInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞">
            </div>

            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</label>
                <textarea id="testDescriptionTextarea" class="form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞"></textarea>
            </div>

            <div class="form-group">
                <label class="flex items-center">
                    <input type="checkbox" id="testIsMainCheckbox" class="mr-2">
                    <span>–ì–ª–∞–≤–Ω—ã–π —Ç–µ—Å—Ç</span>
                </label>
            </div>

            <button type="button" onclick="saveTestChanges()" class="btn btn-primary">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
            </button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ -->
        <div id="questionsContainer" class="hidden_editor mt-6">
            <h3 class="font-bold text-lg mb-4">–í–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞</h3>

            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ -->
<!--            <button type="button" onclick="addNewQuestion()" class="btn btn-success mb-4">-->
<!--                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å-->
<!--            </button>-->

            <div id="questionsList" class="space-y-4">
                <!-- –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <!-- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–£–†–°–ê -->
    <div x-show="subsection === 'edit_course'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-blue-600 mb-4">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</h2>

        <div class="form-group">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</label>
            <select id="courseSelectCourse" onchange="onCourseChangeCourse()" class="form-input">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.title }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫—É—Ä—Å–∞ -->
        <div id="courseEditForm" class="hidden_editor mt-4 p-4 border border-gray-200 rounded">
            <h3 class="font-bold text-lg mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</h3>

            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                <input type="text" id="courseTitleInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞">
            </div>

            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                <textarea id="courseDescriptionTextarea" class="form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞"></textarea>
            </div>

            <button type="button" onclick="saveCourseChanges()" class="btn btn-primary">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–∞
            </button>
        </div>
    </div>

    <!-- –£–î–ê–õ–ï–ù–ò–ï –¢–ï–°–¢–ê -->
    <div x-show="subsection === 'delete_test'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-red-600 mb-4">üóë –£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç</h2>
        <form id="delete-test-form">
            <label class="block font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</label>
            <select name="test_id" required class="w-full input border px-4 py-2 rounded">
                {% for test in tests %}
                    <option value="{{ test.id }}">{{ test.title }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="mt-4 bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">
                –£–¥–∞–ª–∏—Ç—å
            </button>
            <p id="delete-test-status" class="text-green-600 hidden_editor mt-2">‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!</p>
        </form>
    </div>

    <!-- –£–î–ê–õ–ï–ù–ò–ï –ö–£–†–°–ê -->
    <div x-show="subsection === 'delete_course'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-red-600 mb-4">üóë –£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å</h2>
        <form id="delete-course-form">
            <label class="block font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</label>
            <select name="course_id" required class="w-full input border px-4 py-2 rounded">
                {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.title }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="mt-4 bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">
                –£–¥–∞–ª–∏—Ç—å
            </button>
            <p id="delete-course-status" class="text-green-600 hidden_editor mt-2">‚úÖ –ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!</p>
        </form>
    </div>

    <!-- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –£–†–û–ö–ê -->
    <div x-show="subsection === 'edit_lesson'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-blue-600 mb-4">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</h2>

        <div class="space-y-4">
            <!-- –í—ã–±–æ—Ä –∫—É—Ä—Å–∞ -->
            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</label>
                <select id="courseSelectLesson" onchange="onCourseChangeLesson()" class="form-input">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                    {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.title }} ({{ course.lessons|length }} —É—Ä–æ–∫–æ–≤)</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –í—ã–±–æ—Ä —É—Ä–æ–∫–∞ -->
            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫</label>
                <select id="lessonSelectLesson" onchange="onLessonSelectLesson()" disabled class="form-input">
                    <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                </select>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–∫–∞ -->
            <div id="lessonEditForm" class="hidden_editor mt-4 p-4 border border-gray-200 rounded">
                <h3 class="font-bold text-lg mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</h3>

                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</label>
                    <input type="text" id="lessonTitleInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞">
                </div>

                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞</label>
                    <textarea id="lessonDescriptionTextarea" class="form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞"></textarea>
                </div>

                <button type="button" onclick="saveLessonChanges()" class="btn btn-primary">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Ä–æ–∫–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ù–¢–ê -->
    <div x-show="subsection === 'edit_content'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-blue-600 mb-4">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É—Ä–æ–∫–∞</h2>

        <div class="space-y-4">
            <!-- –í—ã–±–æ—Ä –∫—É—Ä—Å–∞ -->
            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</label>
                <select id="courseSelectContent" onchange="onCourseChangeContent()" class="form-input">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                    {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.title }} ({{ course.lessons|length }} —É—Ä–æ–∫–æ–≤)</option>
                    {% endfor %}
                </select>
            </div>

            <!-- –í—ã–±–æ—Ä —É—Ä–æ–∫–∞ -->
            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫</label>
                <select id="lessonSelectContent" onchange="onLessonChangeContent()" disabled class="form-input">
                    <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                </select>
            </div>

            <!-- –í—ã–±–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
            <div id="contentSelectContainer" class="form-group hidden_editor">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                <select id="contentSelect" onchange="onContentChange()" class="form-input">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª --</option>
                </select>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
        <div id="editContentForm" class="hidden_editor mt-6 p-4 border border-gray-200 rounded">
            <h3 class="font-bold text-lg mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h3>

            <div class="form-group">
                <label class="form-label">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                <select id="contentTypeSelect" class="form-input">
                    <option value="txt">–¢–µ–∫—Å—Ç</option>
                    <option value="image">–ö–∞—Ä—Ç–∏–Ω–∫–∞</option>
                    <option value="video">–í–∏–¥–µ–æ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                <input type="text" id="contentTitleInput" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞">
            </div>

            <div class="form-group">
                <label class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                <textarea id="contentBodyTextarea" class="form-textarea" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"></textarea>
            </div>

            <div class="flex space-x-3">
                <button type="button" onclick="saveContentChanges()" class="btn btn-primary">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                </button>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É—Ä–æ–∫–∞ -->
        <div id="allLessonContent" class="hidden_editor mt-6">
            <h3 class="font-bold text-lg mb-4">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã —É—Ä–æ–∫–∞:</h3>
            <div id="contentItems" class="space-y-3">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–ï–°–¢–ê -->
    <div x-show="subsection === 'test'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-indigo-700 mb-4">üß™ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</h2>
        <form id="add-test-form" action="/upload_test_csv" enctype="multipart/form-data">
            <div>
                <label>üìÑ CSV —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏: </label>
                <input type="file" name="csv_asks" accept=".csv" required>
            </div>
            <div>
                <label>üìÑ CSV —Å —á–µ—Ä—Ç–∞–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏: </label>
                <input type="file" name="csv_traits" accept=".csv" required>
            </div>
            <div>
                <label class="block font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã</label>
                <input type="text" name="title" required class="w-full input border px-4 py-2 rounded mt-1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–∫—Ü–µ–Ω—Ç—É–∞—Ü–∏–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞">
            </div>
            <div>
                <label class="block font-medium text-gray-700 mt-4">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã</label>
                <textarea name="description" rows="3" class="w-full input border px-4 py-2 rounded mt-1" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞..."></textarea>
            </div>
            <div class="pt-3">
                <label class="flex items-center">
                    <input type="checkbox" name="is_public" value="true" class="mr-2">
                    <span>–°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç –≥–ª–∞–≤–Ω—ã–º</span>
                </label>
            </div>
            <div class="pt-4">
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                    üíæ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
                </button>
            </div>
            <p id="add-test-status" class="text-green-600 hidden_editor mt-2">‚úÖ –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!</p>
        </form>
    </div>

    <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–£–†–°–ê -->
    <div x-show="subsection === 'course'" class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-semibold text-indigo-600 mb-4">üìò –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å</h2>
        <form id="add-course-form">
            <div>
                <label class="block font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                <input type="text" name="title" required class="w-full input border px-4 py-2 rounded mt-1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑–≤–∏—Ç–∏–µ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏">
            </div>
            <div class="mt-4">
                <label class="block font-medium text-gray-700">–£—Ä–æ–≤–µ–Ω—å (1‚Äì20)</label>
                <select name="level" required class="w-full input border px-4 py-2 rounded mt-1">
                    {% for i in range(1, 21) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mt-4">
                <label class="block font-medium text-gray-700">–¢–∏–ø –∫—É—Ä—Å–∞</label>
                <select name="type" required class="w-full input border px-4 py-2 rounded mt-1">
                    <option value="main">–û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞</option>
                    <option value="secondary">–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è</option>
                </select>
            </div>
            <div class="mt-4">
                <label class="block font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                <textarea name="description" rows="3" class="w-full input border px-4 py-2 rounded mt-1" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞..."></textarea>
            </div>
            <div class="pt-4">
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                    üíæ –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å
                </button>
            </div>
            <p id="add-course-status" class="text-green-600 hidden_editor mt-2">‚úÖ –ö—É—Ä—Å –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!</p>
        </form>
    </div>

    <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï –£–†–û–ö–ê -->
    <div x-show="subsection === 'lesson'" class="bg-white p-6 rounded shadow space-y-4">
        <h2 class="text-xl font-bold text-indigo-700 mb-4">üìñ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</h2>
        <form id="add-lesson-form">
            <div class="mt-4">
                <label class="block font-medium text-gray-700">–ö—É—Ä—Å</label>
                <select name="course_title" required class="w-full input border px-4 py-2 rounded mt-1">
                    {% for course in courses %}
                        <option value="{{ course.title }}">{{ course.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</label>
                <input type="text" name="title" required class="w-full input border px-4 py-2 rounded mt-1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤—ã —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏">
            </div>
            <div class="mt-4">
                <label class="block font-medium text-gray-700">–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞</label>
                <textarea name="description" rows="3" class="w-full input border px-4 py-2 rounded mt-1" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞..."></textarea>
            </div>
            <div class="pt-4">
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
                    üíæ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫
                </button>
            </div>
            <p id="add-lesson-status" class="text-green-600 hidden_editor mt-2">‚úÖ –£—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω</p>
        </form>
    </div>
</div>

<script>
    // –î–∞–Ω–Ω—ã–µ –∏–∑ Flask
    const coursesData = {{ courses | tojson }};

    // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–°–¢–ê –ò –í–û–ü–†–û–°–û–í =====
    // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–°–¢–ê –ò –í–û–ü–†–û–°–û–í =====
    const testSelect = document.getElementById('testSelect');
    const testEditForm = document.getElementById('testEditForm');
    const testTitleInput = document.getElementById('testTitleInput');
    const testDescriptionTextarea = document.getElementById('testDescriptionTextarea');
    const testIsMainCheckbox = document.getElementById('testIsMainCheckbox');
    const questionsContainer = document.getElementById('questionsContainer');
    const questionsList = document.getElementById('questionsList');

    let currentTestData = null;
    let currentQuestions = [];

    function onTestChange() {
        const testId = testSelect.value;

        testEditForm.classList.add('hidden_editor');
        questionsContainer.classList.add('hidden_editor');
        questionsList.innerHTML = '';

        if (testId) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞
            fetch('/get_test_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ test_id: testId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentTestData = data.test;

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ—Å—Ç–∞
                    testTitleInput.value = currentTestData.title || '';
                    testDescriptionTextarea.value = currentTestData.description || '';
                    testIsMainCheckbox.checked = currentTestData.is_main || false;

                    testEditForm.classList.remove('hidden_editor');

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞
                    loadTestQuestions(testId);
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–∞');
            });
        }
    }

    function loadTestQuestions(testId) {
        fetch('/get_test_questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ test_id: testId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentQuestions = data.questions;
                displayQuestions(currentQuestions);
                questionsContainer.classList.remove('hidden_editor');
            } else {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–ø—Ä–æ—Å–æ–≤');
        });
    }

    function displayQuestions(questions) {
        questionsList.innerHTML = '';

        questions.forEach((question, index) => {
            const questionElement = createQuestionElement(question, index);
            questionsList.appendChild(questionElement);
        });
    }

    function createQuestionElement(question, index) {
    const questionDiv = document.createElement('div');
    questionDiv.className = 'question-item';
    questionDiv.innerHTML = `
<!--        <div class="flex justify-between items-center mb-4">-->
<!--            <h4 class="font-bold text-lg">–í–æ–ø—Ä–æ—Å ${index + 1}</h4>-->
<!--            <button type="button" onclick="deleteQuestion(${question.id})" class="btn bg-red-500 text-white hover:bg-red-600">-->
<!--                üóë –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å-->
<!--            </button>-->
<!--        </div>-->

        <div class="form-group">
            <label class="form-label">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</label>
            <textarea class="form-textarea question-content" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞">${question.content || ''}</textarea>
        </div>

        <div class="answers-section mt-4">
            <div class="flex justify-between items-center mb-3">
                <h5 class="font-bold">–û—Ç–≤–µ—Ç—ã:</h5>
            </div>
            <div class="answers-list space-y-2" id="answers-${question.id}">
                ${question.answers ? question.answers.map(answer => `
                    <div class="answer-item" data-answer-id="${answer.id}">
                        <textarea class="form-textarea answer-content w-full" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞">${answer.content || ''}</textarea>
                    </div>
                `).join('') : ''}
            </div>
        </div>

        <div class="mt-4 flex space-x-2">
            <button type="button" onclick="saveQuestionChanges(${question.id})" class="btn btn-primary">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å
            </button>
        </div>
    `;

    return questionDiv;
}

    function saveTestChanges() {
        if (!currentTestData) {
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω —Ç–µ—Å—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const newTitle = testTitleInput.value.trim();
        const newDescription = testDescriptionTextarea.value.trim();
        const isMain = testIsMainCheckbox.checked;

        if (!newTitle) {
            alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        const formData = new FormData();
        formData.append('test_id', currentTestData.id);
        formData.append('title', newTitle);
        formData.append('description', newDescription);
        formData.append('is_main', isMain);

        fetch('/update_test', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
                const option = testSelect.querySelector(`option[value="${currentTestData.id}"]`);
                if (option) {
                    option.textContent = newTitle;
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        });
    }

    function saveQuestionChanges(questionId) {
        const questionElement = document.querySelector(`[onclick="saveQuestionChanges(${questionId})"]`).closest('.question-item');
        const content = questionElement.querySelector('.question-content').value.trim();

        if (!content) {
            alert('–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        const formData = new FormData();
        formData.append('question_id', questionId);
        formData.append('content', content);

        fetch('/update_question', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                saveAllAnswers(questionId);
                alert('–í–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞');
        });
    }

    function saveAllAnswers(questionId) {
        const answersContainer = document.getElementById(`answers-${questionId}`);
        const answerElements = answersContainer.querySelectorAll('.answer-item');

        const updatePromises = [];

        answerElements.forEach((answerElement, index) => {
            const content = answerElement.querySelector('.answer-content').value.trim();

            if (!content) {
                alert('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            const answerId = answerElement.getAttribute('data-answer-id');

            if (answerId) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
                const formData = new FormData();
                formData.append('answer_id', answerId);
                formData.append('content', content);

                const promise = fetch('/update_answer', {
                    method: 'POST',
                    body: formData
                }).then(response => response.json());

                updatePromises.push(promise);
            }
            // –£–±—Ä–∞–ª–∏ –ª–æ–≥–∏–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        });

        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        Promise.all(updatePromises)
            .then(results => {
                results.forEach((result, index) => {
                    if (!result.success) {
                        console.error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ ${index}:`, result.error);
                    }
                });
                alert('–í—Å–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤');
            });
    }

<!--    function addNewQuestion() {-->
<!--        if (!currentTestData) {-->
<!--            alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç');-->
<!--            return;-->
<!--        }-->

<!--        const formData = new FormData();-->
<!--        formData.append('test_id', currentTestData.id);-->
<!--        formData.append('content', '–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å');-->

<!--        fetch('/add_question', {-->
<!--            method: 'POST',-->
<!--            body: formData-->
<!--        })-->
<!--        .then(response => response.json())-->
<!--        .then(data => {-->
<!--            if (data.success) {-->
<!--                alert('–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω!');-->
<!--                loadTestQuestions(currentTestData.id); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã-->
<!--            } else {-->
<!--                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞: ' + data.error);-->
<!--            }-->
<!--        })-->
<!--        .catch(error => {-->
<!--            console.error('–û—à–∏–±–∫–∞:', error);-->
<!--            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞');-->
<!--        });-->
<!--    }-->

<!--    function addAnswerToQuestion(questionId) {-->
<!--        const answersContainer = document.getElementById(`answers-${questionId}`);-->

<!--        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∞-->
<!--        const newAnswerElement = document.createElement('div');-->
<!--        newAnswerElement.className = 'answer-item';-->
<!--        newAnswerElement.innerHTML = `-->
<!--            <div class="answer-header">-->
<!--                <button type="button" onclick="this.closest('.answer-item').remove()" class="btn bg-red-500 text-white text-sm hover:bg-red-600">-->
<!--                    üóë –£–¥–∞–ª–∏—Ç—å –æ—Ç–≤–µ—Ç-->
<!--                </button>-->
<!--            </div>-->
<!--            <textarea class="form-textarea answer-content w-full" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞"></textarea>-->
<!--        `;-->

<!--        answersContainer.appendChild(newAnswerElement);-->

<!--        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É –æ—Ç–≤–µ—Ç—É-->
<!--        newAnswerElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });-->

<!--        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –Ω–æ–≤–æ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞-->
<!--        const textarea = newAnswerElement.querySelector('.answer-content');-->
<!--        textarea.focus();-->
<!--    }-->

<!--    function deleteQuestion(questionId) {-->
<!--        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å?')) {-->
<!--            return;-->
<!--        }-->

<!--        const formData = new FormData();-->
<!--        formData.append('question_id', questionId);-->

<!--        fetch('/delete_question', {-->
<!--            method: 'POST',-->
<!--            body: formData-->
<!--        })-->
<!--        .then(response => response.json())-->
<!--        .then(data => {-->
<!--            if (data.success) {-->
<!--                alert('–í–æ–ø—Ä–æ—Å —É–¥–∞–ª–µ–Ω!');-->
<!--                loadTestQuestions(currentTestData.id); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã-->
<!--            } else {-->
<!--                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞: ' + data.error);-->
<!--            }-->
<!--        })-->
<!--        .catch(error => {-->
<!--            console.error('–û—à–∏–±–∫–∞:', error);-->
<!--            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞');-->
<!--        });-->
<!--    }-->

<!--    function deleteAnswer(answerId) {-->
<!--        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç?')) {-->
<!--            return;-->
<!--        }-->

<!--        const formData = new FormData();-->
<!--        formData.append('answer_id', answerId);-->

<!--        fetch('/delete_answer', {-->
<!--            method: 'POST',-->
<!--            body: formData-->
<!--        })-->
<!--        .then(response => response.json())-->
<!--        .then(data => {-->
<!--            if (data.success) {-->
<!--                alert('–û—Ç–≤–µ—Ç —É–¥–∞–ª–µ–Ω!');-->
<!--                loadTestQuestions(currentTestData.id); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã-->
<!--            } else {-->
<!--                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: ' + data.error);-->
<!--            }-->
<!--        })-->
<!--        .catch(error => {-->
<!--            console.error('–û—à–∏–±–∫–∞:', error);-->
<!--            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞');-->
<!--        });-->
<!--    }-->


    // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–¢–ï–ù–¢–ê =====
    const courseSelectContent = document.getElementById('courseSelectContent');
    const lessonSelectContent = document.getElementById('lessonSelectContent');
    const contentSelectContainer = document.getElementById('contentSelectContainer');
    const contentSelect = document.getElementById('contentSelect');
    const editContentForm = document.getElementById('editContentForm');
    const contentTitleInput = document.getElementById('contentTitleInput');
    const contentBodyTextarea = document.getElementById('contentBodyTextarea');
    const allLessonContent = document.getElementById('allLessonContent');
    const contentItems = document.getElementById('contentItems');

    let currentLessonContent = [];
    let currentlyEditingContent = null;

    function onCourseChangeContent() {
        const courseId = courseSelectContent.value;

        lessonSelectContent.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ --</option>';
        contentSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª --</option>';
        hideAllContent();

        if (courseId) {
            const selectedCourse = coursesData.find(course => course.id == courseId);

            if (selectedCourse && selectedCourse.lessons) {
                selectedCourse.lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.id;
                    option.textContent = lesson.title;
                    lessonSelectContent.appendChild(option);
                });
                lessonSelectContent.disabled = false;
            }
        } else {
            lessonSelectContent.disabled = true;
            lessonSelectContent.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>';
        }
    }

    function onLessonChangeContent() {
        const courseId = courseSelectContent.value;
        const lessonId = lessonSelectContent.value;

        contentSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª --</option>';
        hideAllContent();

        if (courseId && lessonId) {
            const selectedCourse = coursesData.find(course => course.id == courseId);
            const selectedLesson = selectedCourse.lessons.find(lesson => lesson.id == lessonId);

            currentLessonContent = selectedLesson.content || [];

            if (currentLessonContent.length > 0) {
                fillContentSelect(currentLessonContent);
                contentSelectContainer.classList.remove('hidden_editor');
                showAllContent(currentLessonContent);
            } else {
                const noContentMsg = document.createElement('div');
                noContentMsg.className = 'text-gray-500 italic';
                noContentMsg.textContent = '–î–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞';
                contentItems.appendChild(noContentMsg);
                allLessonContent.classList.remove('hidden_editor');
            }
        } else {
            contentSelectContainer.classList.add('hidden_editor');
        }
    }

    function onContentChange() {
        const contentId = contentSelect.value;

        if (contentId) {
            const selectedContentItem = currentLessonContent.find(item => item.id == contentId);
            if (selectedContentItem) {
                loadContentForEditing(selectedContentItem);
            }
        } else {
            editContentForm.classList.add('hidden_editor');
        }
    }

    function fillContentSelect(content) {
        const sortedContent = [...content].sort((a, b) => a.page_num - b.page_num);

        sortedContent.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = `${item.title} (—Å—Ç—Ä. ${item.page_num})`;
            contentSelect.appendChild(option);
        });
    }

    function showAllContent(content) {
        const sortedContent = [...content].sort((a, b) => a.page_num - b.page_num);

        contentItems.innerHTML = '';

        sortedContent.forEach(item => {
            const contentItem = document.createElement('div');
            contentItem.className = 'content-item';
            contentItem.onclick = () => loadContentForEditing(item);

            const title = document.createElement('div');
            title.className = 'content-title';
            title.textContent = `${item.title} (—Å—Ç—Ä. ${item.page_num})`;

            const preview = document.createElement('div');
            preview.className = 'content-preview';
            preview.textContent = item.content.length > 100 ?
                item.content.substring(0, 100) + '...' : item.content;

            contentItem.appendChild(title);
            contentItem.appendChild(preview);
            contentItems.appendChild(contentItem);
        });

        allLessonContent.classList.remove('hidden_editor');
    }

    const contentTypeSelect = document.getElementById('contentTypeSelect');

    function loadContentForEditing(contentItem) {
        currentlyEditingContent = contentItem;

        contentTypeSelect.value = contentItem.type || 'txt';
        contentTitleInput.value = contentItem.title || '';
        contentBodyTextarea.value = contentItem.content || '';

        editContentForm.classList.remove('hidden_editor');
        editContentForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function saveContentChanges() {
        if (!currentlyEditingContent) {
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const newType = contentTypeSelect.value;
        const newTitle = contentTitleInput.value.trim();
        const newContent = contentBodyTextarea.value.trim();

        if (!newTitle) {
            alert('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        const formData = new FormData();
        formData.append('content_id', currentlyEditingContent.id);
        formData.append('type', newType);
        formData.append('title', newTitle);
        formData.append('content', newContent);

        fetch('/update_content', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                currentlyEditingContent.type = newType;
                currentlyEditingContent.title = newTitle;
                currentlyEditingContent.content = newContent;

                const option = contentSelect.querySelector(`option[value="${currentlyEditingContent.id}"]`);
                if (option) {
                    option.textContent = `${newTitle} (${getContentTypeLabel(newType)}, —Å—Ç—Ä. ${currentlyEditingContent.page_num})`;
                }

                showAllContent(currentLessonContent);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    function getContentTypeLabel(type) {
        const typeLabels = {
            'txt': '–¢–µ–∫—Å—Ç',
            'image': '–ö–∞—Ä—Ç–∏–Ω–∫–∞',
            'video': '–í–∏–¥–µ–æ'
        };
        return typeLabels[type] || type;
    }

    function hideAllContent() {
        editContentForm.classList.add('hidden_editor');
        allLessonContent.classList.add('hidden_editor');
        contentSelectContainer.classList.add('hidden_editor');
        contentItems.innerHTML = '';
        currentlyEditingContent = null;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    document.getElementById("add-test-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("/upload_test_csv", {
            method: "POST",
            body: formData
        })
        .then(res => res.ok ? res.text() : Promise.reject("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"))
        .then(() => {
            document.getElementById("add-test-status").classList.remove("hidden_editor");
            this.reset();
        })
        .catch(err => alert("‚ùå " + err));
    });

    document.getElementById("add-course-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("/upload_course", {
            method: "POST",
            body: formData
        })
        .then(res => res.ok ? res.text() : Promise.reject("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞"))
        .then(() => {
            document.getElementById("add-course-status").classList.remove("hidden_editor");
            this.reset();
        })
        .catch(err => alert("‚ùå " + err));
    });

    document.getElementById("add-lesson-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("/upload_lesson", {
            method: "POST",
            body: formData
        })
        .then(res => res.ok ? res.text() : Promise.reject("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞"))
        .then(() => {
            document.getElementById("add-lesson-status").classList.remove("hidden_editor");
            this.reset();
        })
        .catch(err => alert("‚ùå " + err));
    });

    document.getElementById("delete-test-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("/delete_test", {
            method: "POST",
            body: formData
        })
        .then(res => res.ok ? res.text() : Promise.reject("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è"))
        .then(() => {
            document.getElementById("delete-test-status").classList.remove("hidden_editor");
            this.reset();
        })
        .catch(err => alert("‚ùå " + err));
    });

    document.getElementById("delete-course-form").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("/delete_course", {
            method: "POST",
            body: formData
        })
        .then(res => res.ok ? res.text() : Promise.reject("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞"))
        .then(() => {
            document.getElementById("delete-course-status").classList.remove("hidden_editor");
            this.reset();
        })
        .catch(err => alert("‚ùå " + err));
    });

    // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–£–†–°–ê =====
    const courseSelectCourse = document.getElementById('courseSelectCourse');
    const courseEditForm = document.getElementById('courseEditForm');
    const courseTitleInput = document.getElementById('courseTitleInput');
    const courseDescriptionTextarea = document.getElementById('courseDescriptionTextarea');

    let currentCourseData = null;

    function onCourseChangeCourse() {
        const courseId = courseSelectCourse.value;
        courseEditForm.classList.add('hidden_editor');

        if (courseId) {
            // –ù–∞—Ö–æ–¥–∏–º –∫—É—Ä—Å –≤ –¥–∞–Ω–Ω—ã—Ö
            const selectedCourse = coursesData.find(course => course.id == courseId);
            if (selectedCourse) {
                currentCourseData = selectedCourse;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                courseTitleInput.value = currentCourseData.title || '';
                courseDescriptionTextarea.value = currentCourseData.description || '';

                courseEditForm.classList.remove('hidden_editor');
            }
        }
    }

    function saveCourseChanges() {
        if (!currentCourseData) {
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω –∫—É—Ä—Å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const newTitle = courseTitleInput.value.trim();
        const newDescription = courseDescriptionTextarea.value.trim();

        if (!newTitle) {
            alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        const formData = new FormData();
        formData.append('course_id', currentCourseData.id);
        formData.append('title', newTitle);
        formData.append('description', newDescription);

        fetch('/update_course', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const option = courseSelectCourse.querySelector(`option[value="${currentCourseData.id}"]`);
                if (option) {
                    option.textContent = newTitle;
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        });
    }

    // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –£–†–û–ö–ê =====
    const courseSelectLesson = document.getElementById('courseSelectLesson');
    const lessonSelectLesson = document.getElementById('lessonSelectLesson');
    const lessonEditForm = document.getElementById('lessonEditForm');
    const lessonTitleInput = document.getElementById('lessonTitleInput');
    const lessonDescriptionTextarea = document.getElementById('lessonDescriptionTextarea');

    let currentLessonData = null;

    function onCourseChangeLesson() {
        const courseId = courseSelectLesson.value;

        lessonSelectLesson.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ --</option>';
        lessonEditForm.classList.add('hidden_editor');

        if (courseId) {
            const selectedCourse = coursesData.find(course => course.id == courseId);

            if (selectedCourse && selectedCourse.lessons) {
                selectedCourse.lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.id;
                    option.textContent = lesson.title;
                    lessonSelectLesson.appendChild(option);
                });
                lessonSelectLesson.disabled = false; // –í–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä —É—Ä–æ–∫–æ–≤
            }
        } else {
            lessonSelectLesson.disabled = true;
            lessonSelectLesson.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>';
        }
    }

    function onLessonSelectLesson() {
        const lessonId = lessonSelectLesson.value;
        lessonEditForm.classList.add('hidden_editor');

        if (lessonId) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞
            fetch('/get_lesson_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lesson_id: lessonId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentLessonData = data.lesson;

                    lessonTitleInput.value = currentLessonData.title || '';
                    lessonDescriptionTextarea.value = currentLessonData.description || '';

                    lessonEditForm.classList.remove('hidden_editor');
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–∫–∞');
            });
        }
    }

    function saveLessonChanges() {
        if (!currentLessonData) {
            alert('–ù–µ –≤—ã–±—Ä–∞–Ω —É—Ä–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            return;
        }

        const newTitle = lessonTitleInput.value.trim();
        const newDescription = lessonDescriptionTextarea.value.trim();

        if (!newTitle) {
            alert('–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
            return;
        }

        const formData = new FormData();
        formData.append('lesson_id', currentLessonData.id);
        formData.append('title', newTitle);
        formData.append('description', newDescription);

        fetch('/update_lesson', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Ä–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const option = lessonSelectLesson.querySelector(`option[value="${currentLessonData.id}"]`);
                if (option) {
                    option.textContent = newTitle;
                }
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        });
    }

</script>

{% endblock %}